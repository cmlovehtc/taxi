<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <!-- 手機RWD -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>地理環境 &amp; 交通法規測驗｜計程車考試｜台灣計程車模擬考｜執業登記證考試</title>
  <!-- 新增搜尋引擎關鍵字 -->
  <meta name="keywords" content="地理環境, 交通法規, 計程車考試, 台灣計程車模擬考, 執業登記證考試, 智能題庫隨行, 題庫檢視, 全國首創">
  <!-- 引入 Google Fonts (可自行換其他字體) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap">

  <!-- 1) 引入 jsPDF 與 jsPDF-AutoTable (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <!-- 2) 引入繁體中文字型 (將 Base64 版的 NotoSansTC-Regular-normal.js 放同資料夾) -->
  <script src="NotoSansTC-Regular-normal.js"></script>

  <style>
    /* 
     * 全局樣式 
     * ---------------------------------------------------------- */
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: #f3f7fa;
      margin: 0;
      padding: 0;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3 {
      margin-top: 0;
      color: #333;
    }
    a {
      text-decoration: none;
      color: #007bff;
    }
    a:hover {
      text-decoration: underline;
    }

    /* 
     * 容器、按鈕、版面 
     * ---------------------------------------------------------- */
    .container {
      max-width: 1000px;
      margin: auto;
      background: #fff;
      padding: 20px;
      box-shadow: 0 0 12px rgba(0,0,0,0.08);
    }
    .btn {
      display: inline-block;
      padding: 10px 16px;
      margin: 5px 5px 5px 0;
      color: #fff;
      background-color: #006699;
      border-radius: 4px;
      text-decoration: none;
      cursor: pointer;
      border: none;
      font-size: 14px;
    }
    .btn:hover {
      background-color: #004d66;
    }
    .footer {
      margin-top: 20px;
      padding: 10px;
      text-align: center;
      background: #eef4f9;
      font-size: 14px;
      border-radius: 4px;
    }

    /*
     * 首頁與題庫選單
     * ---------------------------------------------------------- */
    #home-container, #bank-container, #quiz-container, #result-container {
      margin-top: 20px;
    }
    .hidden {
      display: none;
    }

    /* 
     * 縣市比例輸入 
     * ---------------------------------------------------------- */
    .region-row {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 300px;
    }
    .region-row label {
      flex: 1;
    }
    .region-row input {
      width: 60px;
      margin-left: 10px;
      padding: 4px;
    }

    /*
     * 顯示統計資訊的表格
     * ---------------------------------------------------------- */
    .stats-table {
      border-collapse: collapse;
      margin: 10px 0;
      width: 100%;
    }
    .stats-table th,
    .stats-table td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: center;
    }
    .stats-table th {
      background: #f0f0f0;
    }

    /*
     * 勾選框區域 
     * ---------------------------------------------------------- */
    #region-checkboxes {
      display: flex;
      flex-wrap: wrap;
      margin: 10px 0;
    }
    #region-checkboxes label {
      width: 33.33%;
      box-sizing: border-box;
      padding: 5px 0;
      font-size: 14px;
    }
    @media (max-width: 600px) {
      #region-checkboxes label {
        width: 50%;
      }
    }

    /*
     * 題庫檢視頁 
     * ---------------------------------------------------------- */
    .bank-top-nav, .bank-sort-nav {
      text-align: center;
      margin-bottom: 10px;
    }
    .bank-top-nav button, .bank-sort-nav button {
      margin: 5px 8px;
      font-size: 14px;
      padding: 6px 12px;
    }
    .bank-footer {
      background: #eef4f9;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      margin-top: 10px;
      border-radius: 4px;
    }

    /* 
     * 兩欄 (題目/答案) 
     * ---------------------------------------------------------- */
    .bank-content-page {
      display: grid;
      grid-template-columns: calc(100% - 20px) 20px;
      gap: 10px;
      padding: 10px;
      border-top: 1px solid #ccc;
    }
    .bank-question {
      padding: 5px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .bank-answer {
      padding: 5px;
      color: transparent; /* 預設隱藏答案 */
      transition: color 0.3s;
      text-align: right;
    }
    .bank-answer.show,
    .bank-answer:hover {
      color: #333;
    }
    .highlight {
      background-color: #fffae6;
    }
    .bank-question:hover,
    .bank-answer:hover {
      cursor: pointer;
    }

    /* 
     * 分頁按鈕 
     * ---------------------------------------------------------- */
    .bank-pagination {
      margin: 10px 0;
      text-align: center;
    }

    /* 
     * 測驗頁面 (Quiz) 
     * ---------------------------------------------------------- */
    .question-block {
      border: 1px solid #ccc;
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      word-wrap: break-word;
      background: #f8fafc;
    }
    #quiz-nav {
      text-align: center;
    }

    /* 
     * 結果頁 (Result) 
     * ---------------------------------------------------------- */
    .result {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 10px 0;
      text-align: center;
    }
    .wrong {
      color: red;
      font-weight: bold;
    }
    .correct {
      color: green;
      font-weight: bold;
    }

    /* 
     * 載入指示器 
     * ---------------------------------------------------------- */
    #loading-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    /* 
     * 新增：自訂題數輸入區的樣式 
     * ---------------------------------------------------------- */
    .custom-questions-container {
      margin-top: 10px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }
    .custom-questions-container label {
      margin-right: 8px;
    }
    .custom-questions-container input {
      width: 60px;
      margin-right: 16px;
      padding: 4px;
    }

  </style>
</head>
<body>

  <div class="container">
    <!-- 載入指示器 -->
    <div id="loading-indicator" class="hidden">
      <p>正在載入題庫，請稍候...</p>
    </div>

    <!-- 首頁容器 (Home) -->
    <div id="home-container">
      <h1>全國版 地理環境 &amp; 交通法規測驗</h1>
      <h2>計程車考試｜台灣計程車模擬考｜執業登記證考試</h2>
      <p>
        全國首創 <strong>智能題庫隨行</strong> 機制，讓您在檢視題庫時，移動或點擊題目即可即時顯示正確答案，提供最佳考前複習體驗！
      </p>
      
      <!-- 比例輸入區 -->
      <h3>請輸入各縣市的比例 (總和=100)</h3>
      <div id="region-inputs"></div>
      <div style="margin-top:10px;">
        <button class="btn" id="start-geo">地理位置開始測驗</button>
        <button class="btn" id="start-traffic">開始交通法規測驗（50題）</button>
        <button class="btn" id="start-wrong-practice">錯誤題目練習</button>
        <button class="btn" id="clear-wrong">清除錯誤題目</button>
        <button class="btn" id="view-bank-menu">查看題庫</button>
      </div>

      <!-- 新增：自訂題數輸入區 (預設唯讀) -->
      <div class="custom-questions-container">
        <label>是非題</label>
        <input type="number" id="custom-tf" value="20" readonly>
        <label>選擇題</label>
        <input type="number" id="custom-mc" value="30" readonly>
        <button class="btn" id="toggle-custom-btn">自訂義出題數量</button>
      </div>

      <h3>選擇要包含的縣市</h3>
      <div id="region-checkboxes"></div>
      <button class="btn" id="calculate-stats">計算統計</button>
      <button class="btn" id="toggle-select-all">全部勾選</button>

      <h3>各縣市題庫數量及統計</h3>
      <div id="stats-info" class="hidden"></div>

      <div class="footer">
        郭建隆自動出題程式祝大家考試順利<br>
        更新日期:2025/1/14日<br>
        郭建隆版權所有<br>
        聯絡作者: cmlovehtc@gmail.com<br>
        LINE: cmlovehtc (歡迎加LINE提供你考試密技，計程車車隊分析)
      </div>
    </div>

    <!-- 題庫選單 & 內容容器 (Bank) -->
    <div id="bank-container" class="hidden">
      <h2>查看題庫選單</h2>
      <div id="bank-menu"></div>
      <hr>
      <div id="bank-content"></div>
    </div>

    <!-- 測驗容器 (Quiz) -->
    <div id="quiz-container" class="hidden">
      <h3 id="quiz-page-title"></h3>
      <div id="quiz-questions"></div>
      <div id="quiz-nav" style="margin:10px 0;"></div>
    </div>

    <!-- 結果容器 (Result) -->
    <div id="result-container" class="hidden">
      <div id="result-area"></div>
    </div>

  </div> <!-- /.container -->

  <script>
    /*
     * 1. 全域變數、初始設定
     * ---------------------------------------------------------- */
    const REGIONS = [
      "基隆市","宜蘭縣","新北市","桃園市","新竹市",
      "新竹縣","苗栗縣","臺北市","臺中市","南投縣",
      "彰化縣","雲林縣","嘉義縣","嘉義市","臺南市",
      "高雄市","屏東縣","花蓮縣","臺東縣","澎湖縣",
      "金門縣","連江縣"
    ];
    const QUESTION_TYPES = ["是非題","選擇題"];

    const HOME_CONTAINER   = document.getElementById('home-container');
    const QUIZ_CONTAINER   = document.getElementById('quiz-container');
    const RESULT_CONTAINER = document.getElementById('result-container');
    const BANK_CONTAINER   = document.getElementById('bank-container');
    const LOADING_INDICATOR = document.getElementById('loading-indicator');

    // questions[region] = { "是非題": [...], "選擇題": [] }
    let questions = {};
    REGIONS.forEach(r => {
      questions[r] = { "是非題": [], "選擇題": [] };
    });
    questions["交通法令"] = { "是非題": [], "選擇題": [] };

    let proportions = {};
    let selectedQuestions = { "是非題": [], "選擇題": [] };
    let userAnswers = {};      // key: 全卷題號, val: 使用者選的選項數字
    let correctAnswers = {};   // key: 全卷題號, val: 正確選項
    let score = 0;

    // 狀態參數
    let trafficMode = false;   // 是否交通法規測驗
    let wrongMode = false;     // 是否「錯誤題目練習」模式
    let currentPage = 0;       // 分頁
    let totalPage = 0;         // 總頁數

    // 自訂題數
    let customTfInput = document.getElementById('custom-tf');
    let customMcInput = document.getElementById('custom-mc');
    let toggleCustomBtn = document.getElementById('toggle-custom-btn');
    let customEditable = false; // 是否允許編輯

    // 讀取 localStorage 的錯題
    let wrongQuestionsStorage = localStorage.getItem("wrongQuestions");
    let wrongQuestions = wrongQuestionsStorage ? JSON.parse(wrongQuestionsStorage) : [];

    /*
     * 2. 建立「輸入比例」區 & 綁定按鈕
     * ---------------------------------------------------------- */
    const regionInputsDiv = document.getElementById('region-inputs');
    REGIONS.forEach(r => {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'region-row';
      rowDiv.innerHTML = `
        <label>${r}</label>
        <input type="number" id="prop-${r}" value="0">
      `;
      // 如果 focus 到 input，若值為0就清空
      const inputEl = rowDiv.querySelector('input');
      inputEl.addEventListener('focus', () => {
        if(inputEl.value === "0"){
          inputEl.value = "";
        }
      });
      regionInputsDiv.appendChild(rowDiv);
    });

    // 綁定按鈕
    document.getElementById('start-traffic').addEventListener('click', startTrafficTest);
    document.getElementById('start-geo').addEventListener('click', startGeoTest);
    document.getElementById('view-bank-menu').addEventListener('click', showBankMenu);
    document.getElementById('calculate-stats').addEventListener('click', renderStatsInfo);
    document.getElementById('start-wrong-practice').addEventListener('click', startWrongPractice);
    document.getElementById('clear-wrong').addEventListener('click', clearWrong);

    // 全部勾選/取消勾選
    let toggleSelectAllBtn = document.getElementById('toggle-select-all');
    let selectAllState = false; // false=顯示「全部勾選」、true=顯示「取消勾選」
    toggleSelectAllBtn.addEventListener('click', () => {
      selectAllState = !selectAllState;
      let cbs = document.querySelectorAll('#region-checkboxes input[type="checkbox"]');
      cbs.forEach(cb => cb.checked = selectAllState);
      toggleSelectAllBtn.textContent = selectAllState ? "取消勾選" : "全部勾選";
    });

    // 自訂義出題數量 (預設唯讀)
    toggleCustomBtn.addEventListener('click', () => {
      customEditable = !customEditable;
      if(customEditable) {
        customTfInput.removeAttribute('readonly');
        customMcInput.removeAttribute('readonly');
        customTfInput.focus();
        toggleCustomBtn.textContent = "還原預設值";
      } else {
        // 還原預設
        customTfInput.value = 20;
        customMcInput.value = 30;
        customTfInput.setAttribute('readonly', true);
        customMcInput.setAttribute('readonly', true);
        toggleCustomBtn.textContent = "自訂義出題數量";
      }
    });

    // 載入題庫
    window.addEventListener('DOMContentLoaded', async () => {
      await loadAllQuestions();
      renderRegionCheckboxes();
      renderBankMenu();
    });

    /*
     * 3. 載入題庫 (平行載入所有 TXT 檔案)
     * ---------------------------------------------------------- */
    async function loadAllQuestions() {
      LOADING_INDICATOR.classList.remove('hidden');
      const fetchPromises = [];
      for (const region of [...REGIONS, "交通法令"]) {
        for (const qtype of QUESTION_TYPES) {
          let filename = (region === "交通法令")
            ? `${region}_${qtype}.txt`
            : `${region}_地理環境_${qtype}.txt`;
          const fetchPromise = fetch(filename)
            .then(res => {
              if (!res.ok) {
                console.log(`無法讀取: ${filename}`);
                return null;
              }
              return res.text();
            })
            .then(text => {
              if (text) {
                parseTextToQuestions(region, qtype, text);
              }
            })
            .catch(e => {
              console.log(`fetch 錯誤: ${filename}`, e);
            });
          fetchPromises.push(fetchPromise);
        }
      }
      await Promise.all(fetchPromises);
      LOADING_INDICATOR.classList.add('hidden');
    }

    function parseTextToQuestions(region, qtype, text) {
      const lines = text.split('\n');
      const patternParen = /\((\d+)\)([^()]*)/g;
      lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        if (line.includes("答案:")) {
          const [qpart, apart] = line.split("答案:");
          const questionText = qpart.trim();
          const answerText = apart.trim();
          if(qtype === "是非題") {
            let ansVal = 0;
            if(answerText === "是") ansVal = 1;
            else if(answerText === "否") ansVal = 2;
            if(ansVal > 0) {
              questions[region][qtype].push({
                question: questionText,
                answer: ansVal,  // 1=是, 2=否
                region: region
              });
            }
          } else {
            // 選擇題
            let matches = [...questionText.matchAll(patternParen)];
            if(matches.length > 0) {
              const firstIndex = questionText.indexOf(`(${matches[0][1]})`);
              const qTxt = questionText.slice(0, firstIndex).trim();
              let opts = {};
              matches.forEach(m => {
                let num = parseInt(m[1], 10);
                let txt = m[2].replace(/[。]/g, "").trim();
                opts[num] = txt;
              });
              let correct = parseInt(answerText, 10) || 0;
              questions[region][qtype].push({
                question: qTxt,
                options: opts,
                answer: correct,
                region: region
              });
            } else {
              questions[region][qtype].push({
                question: questionText,
                options: {},
                answer: answerText,
                region: region
              });
            }
          }
        }
      });
    }

    /*
     * 4. 建立勾選框 (統計)
     * ---------------------------------------------------------- */
    function renderRegionCheckboxes() {
      const checkboxDiv = document.getElementById('region-checkboxes');
      checkboxDiv.innerHTML = "";
      REGIONS.forEach(r => {
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" value="${r}"> ${r}`;
        checkboxDiv.appendChild(label);
      });
    }

    /*
     * 5. 統計資訊
     * ---------------------------------------------------------- */
    function renderStatsInfo() {
      const statsDiv = document.getElementById('stats-info');
      statsDiv.innerHTML = "";
      const selectedRegions = Array.from(document.querySelectorAll('#region-checkboxes input[type="checkbox"]:checked'))
                                .map(cb => cb.value);
      if(selectedRegions.length === 0){
        alert("請至少選擇一個縣市來顯示統計資訊。");
        return;
      }
      const table = document.createElement('table');
      table.className = 'stats-table';
      table.innerHTML = `
        <thead>
          <tr>
            <th>地區(或交通法令)</th>
            <th>是非題數量(是/否)</th>
            <th>選擇題數量(1/2/3)</th>
          </tr>
        </thead>
      `;
      let tbody = document.createElement('tbody');
      [...selectedRegions, "交通法令"].forEach(region => {
        let tfArr = questions[region]["是非題"];
        let mcArr = questions[region]["選擇題"];
        let tfTrue = tfArr.filter(q => q.answer === 1).length;
        let tfFalse = tfArr.filter(q => q.answer === 2).length;
        let tfDesc = `${tfArr.length} 題(是:${tfTrue}, 否:${tfFalse})`;
        if(tfTrue > tfFalse){
          tfDesc += `，出現較多：是(${tfTrue})`;
        } else if(tfFalse > tfTrue){
          tfDesc += `，出現較多：否(${tfFalse})`;
        }
        let mcCount1 = mcArr.filter(q => q.answer === 1).length;
        let mcCount2 = mcArr.filter(q => q.answer === 2).length;
        let mcCount3 = mcArr.filter(q => q.answer === 3).length;
        let mcDesc = `${mcArr.length} 題(1:${mcCount1}, 2:${mcCount2}, 3:${mcCount3})`;
        let maxVal = Math.max(mcCount1, mcCount2, mcCount3);
        if(maxVal > 0){
          let tmp = [];
          if(mcCount1 === maxVal) tmp.push("1");
          if(mcCount2 === maxVal) tmp.push("2");
          if(mcCount3 === maxVal) tmp.push("3");
          mcDesc += `，出現最多：${tmp.join("/")} (${maxVal})`;
        }
        let tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${region}</td>
          <td>${tfDesc}</td>
          <td>${mcDesc}</td>
        `;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      statsDiv.appendChild(table);
      statsDiv.classList.remove('hidden');
      statsDiv.scrollIntoView({ behavior: 'smooth' });
    }

    /*
     * 6. 題庫檢視功能 + PDF 產生 (含中文字型 & 只第一頁表頭)
     * ---------------------------------------------------------- */
    function showBankMenu(){
      HOME_CONTAINER.classList.add('hidden');
      QUIZ_CONTAINER.classList.add('hidden');
      RESULT_CONTAINER.classList.add('hidden');
      BANK_CONTAINER.classList.remove('hidden');
      renderBankMenu();
      document.getElementById('bank-content').innerHTML = "";
      window.scrollTo(0, 0);
    }

    // 顯示各縣市及題型按鈕
    function renderBankMenu(){
      const bankMenuDiv = document.getElementById('bank-menu');
      bankMenuDiv.innerHTML = "";
      let listAll = [...REGIONS, "交通法令"];
      listAll.forEach(region => {
        QUESTION_TYPES.forEach(qtype => {
          let btn = document.createElement('button');
          btn.className = "btn";
          btn.style.marginRight = "6px";
          btn.textContent = `${region} ${qtype}`;
          btn.onclick = () => {
            bankCurrentPage = 0;
            bankShowAllAnswer = false;
            selectedRegion = region; // 用於 PDF 命名
            bankMenuDiv.innerHTML = "";
            showQuestionBank(region, qtype);
          };
          bankMenuDiv.appendChild(btn);
        });
        bankMenuDiv.appendChild(document.createElement('br'));
      });
    }

    // Hover/Click 事件 → 顯示答案
    function addHighlightEvents(leftDiv, rightDiv) {
      // 滑鼠事件
      leftDiv.addEventListener('mouseenter', () => {
        rightDiv.classList.add('show');
        leftDiv.classList.add('highlight');
        rightDiv.classList.add('highlight');
      });
      leftDiv.addEventListener('mouseleave', () => {
        if(!rightDiv.classList.contains('toggle')) {
          rightDiv.classList.remove('show');
          leftDiv.classList.remove('highlight');
          rightDiv.classList.remove('highlight');
        }
      });
      leftDiv.addEventListener('click', () => {
        leftDiv.classList.toggle('toggle');
        rightDiv.classList.toggle('toggle');
        if(rightDiv.classList.contains('toggle')) {
          rightDiv.classList.add('show');
          leftDiv.classList.add('highlight');
          rightDiv.classList.add('highlight');
        } else {
          rightDiv.classList.remove('show');
          leftDiv.classList.remove('highlight');
          rightDiv.classList.remove('highlight');
        }
      });
      // 同樣對右側做處理
      rightDiv.addEventListener('mouseenter', () => {
        leftDiv.classList.add('highlight');
        rightDiv.classList.add('highlight');
      });
      rightDiv.addEventListener('mouseleave', () => {
        if(!leftDiv.classList.contains('toggle')) {
          leftDiv.classList.remove('highlight');
          rightDiv.classList.remove('highlight');
        }
      });
      rightDiv.addEventListener('click', () => {
        leftDiv.classList.toggle('toggle');
        rightDiv.classList.toggle('toggle');
        if(leftDiv.classList.contains('toggle')) {
          leftDiv.classList.add('highlight');
          rightDiv.classList.add('highlight');
          rightDiv.classList.add('show');
        } else {
          leftDiv.classList.remove('highlight');
          rightDiv.classList.remove('highlight');
          rightDiv.classList.remove('show');
        }
      });
      // 行動裝置（觸控）事件
      leftDiv.addEventListener('touchend', (e) => {
        e.preventDefault();
        leftDiv.classList.toggle('toggle');
        rightDiv.classList.toggle('toggle');
        if(rightDiv.classList.contains('toggle')) {
          rightDiv.classList.add('show');
          leftDiv.classList.add('highlight');
          rightDiv.classList.add('highlight');
        } else {
          rightDiv.classList.remove('show');
          leftDiv.classList.remove('highlight');
          rightDiv.classList.remove('highlight');
        }
      }, { passive: false });
      rightDiv.addEventListener('touchend', (e) => {
        e.preventDefault();
        leftDiv.classList.toggle('toggle');
        rightDiv.classList.toggle('toggle');
        if(leftDiv.classList.contains('toggle')) {
          leftDiv.classList.add('highlight');
          rightDiv.classList.add('highlight');
          rightDiv.classList.add('show');
        } else {
          leftDiv.classList.remove('highlight');
          rightDiv.classList.remove('highlight');
          rightDiv.classList.remove('show');
        }
      }, { passive: false });
    }

    // PDF 產生
    function generatePDF(region, qtype, sortMethod) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: 'p',
        unit: 'pt',
        format: 'A4'
      });

      // 加入 Base64 字型
      doc.addFileToVFS("NotoSansTC-Regular.ttf", NotoSansTCRegular);
      doc.addFont("NotoSansTC-Regular.ttf", "NotoSansTC", "normal");
      doc.setFont("NotoSansTC", "normal");
      doc.setTextColor(0, 0, 0);

      let tableData = bankAllData.map(item => {
        let questionStr = item.index + ". " + item.question;
        if (qtype === '選擇題' && item.options && Object.keys(item.options).length > 0) {
          const sortedKeys = Object.keys(item.options).sort((a, b) => parseInt(a) - parseInt(b));
          sortedKeys.forEach(k => {
            questionStr += ` ( ${k} ) ${item.options[k]}`;
          });
        }

        let ansStr = "";
        if (qtype === '選擇題') {
          ansStr = item.answer.toString();
        } else {
          ansStr = (item.answer === 1) ? "是" : "否";
        }

        return { question: questionStr, answer: ansStr };
      });

      doc.autoTable({
        columns: [
          { header: '題目', dataKey: 'question' },
          { header: '答案', dataKey: 'answer' }
        ],
        body: tableData,
        startY: 20,
        margin: { left: 20, right: 20 },
        repeatHeaders: 'firstPage',  // 只在第一頁重複表頭

        headStyles: {
          fillColor: [238, 244, 249],
          textColor: 50,
          lineWidth: 0.1,
          font: "NotoSansTC",
          fontSize: 8,
          halign: 'center',
        },
        bodyStyles: {
          lineWidth: 0.1,
          font: "NotoSansTC",
          fontSize: 8,
          textColor: [0, 0, 0],
          cellPadding: 2,
        },
        styles: {
          overflow: 'linebreak',
          lineHeight: 1,
        },
        columnStyles: {
          answer: { halign: 'center' }
        },
      });

      const fileName = `${region}__地理環境_${qtype}_${sortMethod}.pdf`;
      doc.save(fileName);
    }

    // 排序按鈕 (題庫檢視用)
    function renderSortNav(qtype) {
      const sortNav = document.createElement('div');
      sortNav.className = "bank-sort-nav";

      if(qtype === "是非題") {
        let sortYesBtn = document.createElement('button');
        sortYesBtn.className = "btn";
        sortYesBtn.textContent = "答案是排序";
        sortYesBtn.onclick = () => {
          currentSortMethod = "答案是排序";
          bankAllData.sort((a, b) => {
            if(a.answer === b.answer) return a.index - b.index;
            return (a.answer === 1) ? -1 : (b.answer === 1) ? 1 : 0;
          });
          renderBankPage(qtype);
          window.scrollTo(0, 0);
        };
        sortNav.appendChild(sortYesBtn);

        let sortNoBtn = document.createElement('button');
        sortNoBtn.className = "btn";
        sortNoBtn.textContent = "答案否排序";
        sortNoBtn.onclick = () => {
          currentSortMethod = "答案否排序";
          bankAllData.sort((a, b) => {
            if(a.answer === b.answer) return a.index - b.index;
            return (a.answer === 2) ? -1 : (b.answer === 2) ? 1 : 0;
          });
          renderBankPage(qtype);
          window.scrollTo(0, 0);
        };
        sortNav.appendChild(sortNoBtn);

        let sortIndexBtn = document.createElement('button');
        sortIndexBtn.className = "btn";
        sortIndexBtn.textContent = "題號排序";
        sortIndexBtn.onclick = () => {
          currentSortMethod = "題號排序";
          bankAllData.sort((a, b) => a.index - b.index);
          renderBankPage(qtype);
          window.scrollTo(0, 0);
        };
        sortNav.appendChild(sortIndexBtn);
      }
      else if(qtype === "選擇題") {
        let sort1Btn = document.createElement('button');
        sort1Btn.className = "btn";
        sort1Btn.textContent = "1排序";
        sort1Btn.onclick = () => {
          currentSortMethod = "1排序";
          bankAllData.sort((a, b) => {
            if(a.answer === b.answer) return a.index - b.index;
            return (a.answer === 1) ? -1 : (b.answer === 1) ? 1 : 0;
          });
          renderBankPage(qtype);
          window.scrollTo(0, 0);
        };
        sortNav.appendChild(sort1Btn);

        let sort2Btn = document.createElement('button');
        sort2Btn.className = "btn";
        sort2Btn.textContent = "2排序";
        sort2Btn.onclick = () => {
          currentSortMethod = "2排序";
          bankAllData.sort((a, b) => {
            if(a.answer === b.answer) return a.index - b.index;
            return (a.answer === 2) ? -1 : (b.answer === 2) ? 1 : 0;
          });
          renderBankPage(qtype);
          window.scrollTo(0, 0);
        };
        sortNav.appendChild(sort2Btn);

        let sort3Btn = document.createElement('button');
        sort3Btn.className = "btn";
        sort3Btn.textContent = "3排序";
        sort3Btn.onclick = () => {
          currentSortMethod = "3排序";
          bankAllData.sort((a, b) => {
            if(a.answer === b.answer) return a.index - b.index;
            return (a.answer === 3) ? -1 : (b.answer === 3) ? 1 : 0;
          });
          renderBankPage(qtype);
          window.scrollTo(0, 0);
        };
        sortNav.appendChild(sort3Btn);

        let sortIndexBtn = document.createElement('button');
        sortIndexBtn.className = "btn";
        sortIndexBtn.textContent = "題號排序";
        sortIndexBtn.onclick = () => {
          currentSortMethod = "題號排序";
          bankAllData.sort((a, b) => a.index - b.index);
          renderBankPage(qtype);
          window.scrollTo(0, 0);
        };
        sortNav.appendChild(sortIndexBtn);
      }

      let pdfBtn = document.createElement('button');
      pdfBtn.className = "btn";
      pdfBtn.textContent = "產生 PDF";
      pdfBtn.style.marginLeft = "20px";
      pdfBtn.onclick = () => generatePDF(selectedRegion, qtype, currentSortMethod);
      sortNav.appendChild(pdfBtn);

      return sortNav;
    }

    // 顯示題庫
    let bankCurrentPage = 0;
    let bankAllData = [];
    let bankTotalPages = 0;
    let bankShowAllAnswer = false;
    let currentSortMethod = "題號排序";

    function showQuestionBank(region, qtype){
      const bankContent = document.getElementById('bank-content');
      bankContent.innerHTML = `
        <div class="bank-top-nav">
          <button class="btn" id="back-to-menu">回題庫選單</button>
          <button class="btn" id="back-to-home">回首頁</button>
          <button class="btn" id="toggle-answer">顯示所有答案</button>
        </div>
        <div id="bank-sort-area"></div>
        <div id="bank-page-view"></div>
        <div class="bank-footer">移動或點擊題目會顯示答案</div>
      `;
      document.getElementById('back-to-menu').addEventListener('click', () => {
        renderBankMenu();
        bankContent.innerHTML = "";
        window.scrollTo(0, 0);
      });
      document.getElementById('back-to-home').addEventListener('click', () => {
        BANK_CONTAINER.classList.add('hidden');
        HOME_CONTAINER.classList.remove('hidden');
        bankContent.innerHTML = "";
        window.scrollTo(0, 0);
      });
      document.getElementById('toggle-answer').addEventListener('click', () => {
        bankShowAllAnswer = !bankShowAllAnswer;
        const toggleBtn = document.getElementById('toggle-answer');
        toggleBtn.textContent = bankShowAllAnswer ? "隱藏所有答案" : "顯示所有答案";
        renderBankPage(qtype);
        window.scrollTo(0, 0);
      });

      const sortArea = document.getElementById('bank-sort-area');
      sortArea.innerHTML = "";
      sortArea.appendChild(renderSortNav(qtype));
      
      // 填充 bankAllData
      let arr = questions[region][qtype];
      bankAllData = [];
      arr.forEach((qObj, idx) => {
        bankAllData.push(Object.assign({ index: idx + 1 }, qObj));
      });
      bankTotalPages = Math.ceil(bankAllData.length / 50);
      bankCurrentPage = 0;
      renderBankPage(qtype);
      window.scrollTo(0, 0);
    }

    function renderBankPage(qtype){
      const pageView = document.getElementById('bank-page-view');
      if(!pageView) return;
      pageView.innerHTML = "";
      const start = bankCurrentPage * 50;
      const end = start + 50;
      const pageData = bankAllData.slice(start, end);

      const contentDiv = document.createElement('div');
      contentDiv.className = "bank-content-page";

      pageData.forEach(item => {
        const leftDiv = document.createElement('div');
        leftDiv.className = "bank-question";
        let leftContent = `${item.index}. ${item.question}`;
        if(qtype === "選擇題" && item.options && Object.keys(item.options).length > 0){
          leftContent += "\n";
          const sortedKeys = Object.keys(item.options).sort((a, b) => parseInt(a) - parseInt(b));
          sortedKeys.forEach(k => {
            leftContent += `(${k}) ${item.options[k]}\n`;
          });
        }
        leftDiv.textContent = leftContent;

        const rightDiv = document.createElement('div');
        rightDiv.className = "bank-answer";
        if(qtype === "選擇題"){
          rightDiv.textContent = item.answer;
        } else {
          rightDiv.textContent = (item.answer === 1) ? "是" : "否";
        }
        if(bankShowAllAnswer){
          rightDiv.classList.add('show');
        } else {
          rightDiv.classList.remove('show');
        }
        addHighlightEvents(leftDiv, rightDiv);

        contentDiv.appendChild(leftDiv);
        contentDiv.appendChild(rightDiv);
      });

      pageView.appendChild(contentDiv);

      const paginationContainer = document.createElement('div');
      paginationContainer.className = "bank-pagination";
      const pageInfo = document.createElement('div');
      pageInfo.textContent = `第 ${bankCurrentPage + 1} 頁，共 ${bankTotalPages} 頁`;
      paginationContainer.appendChild(pageInfo);
      
      const navDiv = document.createElement('div');
      if(bankCurrentPage > 0){
        const prevBtn = document.createElement('button');
        prevBtn.className = "btn";
        prevBtn.textContent = "上一頁";
        prevBtn.onclick = () => {
          bankCurrentPage--;
          renderBankPage(qtype);
          window.scrollTo(0, 0);
        };
        navDiv.appendChild(prevBtn);
      }
      if(bankCurrentPage < bankTotalPages - 1){
        const nextBtn = document.createElement('button');
        nextBtn.className = "btn";
        nextBtn.textContent = "下一頁";
        nextBtn.onclick = () => {
          bankCurrentPage++;
          renderBankPage(qtype);
          window.scrollTo(0, 0);
        };
        navDiv.appendChild(nextBtn);
      }
      paginationContainer.appendChild(navDiv);
      pageView.appendChild(paginationContainer);
    }

    /*
     * 7. 開始測驗 (交通/地理/錯誤題目)
     * ---------------------------------------------------------- */
    function startTrafficTest(){
      wrongMode = false;
      trafficMode = true;
      let ret = selectQuestionsTraffic();
      if(!ret) return; // 代表題庫不足或錯誤 -> 中斷
      startQuizCommon();
    }

    function startGeoTest(){
      wrongMode = false;
      trafficMode = false;
      let total = 0;
      proportions = {};
      REGIONS.forEach(r => {
        let val = document.getElementById(`prop-${r}`).value;
        let num = parseInt(val,10) || 0;
        proportions[r] = num;
        total += num;
      });
      if(total !== 100){
        alert(`縣市比例加總必須為100，目前為 ${total}`);
        return;
      }
      let ret = selectQuestionsCity();
      if(!ret) return;
      startQuizCommon();
    }

    function startWrongPractice(){
      if(wrongQuestions.length === 0){
        alert("目前沒有錯誤題目可以練習。");
        return;
      }
      wrongMode = true;
      trafficMode = false; 
      selectedQuestions = { "是非題": [], "選擇題": [] };

      // 將 wrongQuestions 分類成 地理是非 / 地理選擇 / 交通是非 / 交通選擇
      let geoTF = wrongQuestions.filter(q => !q.options && q.region !== "交通法令");
      let geoMC = wrongQuestions.filter(q => q.options && q.region !== "交通法令");
      let trafficTF = wrongQuestions.filter(q => !q.options && q.region === "交通法令");
      let trafficMC = wrongQuestions.filter(q => q.options && q.region === "交通法令");

      // 組合：地理是非→地理選擇→交通是非→交通選擇
      selectedQuestions["是非題"] = [...geoTF, ...trafficTF];
      selectedQuestions["選擇題"] = [...geoMC, ...trafficMC];

      startQuizCommon();
    }

    function clearWrong(){
      if(confirm("確定要清除所有錯誤題目紀錄嗎？")){
        wrongQuestions = [];
        localStorage.removeItem("wrongQuestions");
        alert("已清除所有錯誤題目。");
      }
    }

    function startQuizCommon(){
      currentPage = 0;
      userAnswers = {};
      correctAnswers = {};
      HOME_CONTAINER.classList.add('hidden');
      BANK_CONTAINER.classList.add('hidden');
      RESULT_CONTAINER.classList.add('hidden');
      QUIZ_CONTAINER.classList.remove('hidden');
      showQuestionPage();
    }

    /*
     * 8. 選題 & 檢查題庫數量
     * ---------------------------------------------------------- */
    function selectQuestionsCity(){
      selectedQuestions = { "是非題": [], "選擇題": [] };

      let totalTF = parseInt(customTfInput.value, 10) || 20;
      let totalMC = parseInt(customMcInput.value, 10) || 30;

      // 檢查每個地區題庫是否足夠
      for(let r of REGIONS){
        let tfNeeded = Math.round(proportions[r] / 100 * totalTF);
        if(tfNeeded > questions[r]["是非題"].length){
          alert(`你輸入出題題目大於題庫數量：${r} 是非題僅有 ${questions[r]["是非題"].length} 題。`);
          return false;
        }
        let mcNeeded = Math.round(proportions[r] / 100 * totalMC);
        if(mcNeeded > questions[r]["選擇題"].length){
          alert(`你輸入出題題目大於題庫數量：${r} 選擇題僅有 ${questions[r]["選擇題"].length} 題。`);
          return false;
        }
      }

      // 分配 是非題
      REGIONS.forEach(r => {
        let need = Math.round(proportions[r] / 100 * totalTF);
        let pool = questions[r]["是非題"];
        if(pool.length > 0){
          let pickCount = Math.min(need, pool.length);
          let picked = randomPick(pool, pickCount);
          selectedQuestions["是非題"].push(...picked);
        }
      });
      // 不足的部分隨機補齊
      while(selectedQuestions["是非題"].length < totalTF){
        let rr = randomItem(REGIONS);
        let p = questions[rr]["是非題"];
        if(!p.length) continue;
        let c = randomItem(p);
        if(!selectedQuestions["是非題"].includes(c)){
          selectedQuestions["是非題"].push(c);
        }
      }

      // 分配 選擇題
      REGIONS.forEach(r => {
        let need = Math.round(proportions[r] / 100 * totalMC);
        let pool = questions[r]["選擇題"];
        if(pool.length > 0){
          let pickCount = Math.min(need, pool.length);
          let picked = randomPick(pool, pickCount);
          selectedQuestions["選擇題"].push(...picked);
        }
      });
      while(selectedQuestions["選擇題"].length < totalMC){
        let rr = randomItem(REGIONS);
        let p = questions[rr]["選擇題"];
        if(!p.length) continue;
        let c = randomItem(p);
        if(!selectedQuestions["選擇題"].includes(c)){
          selectedQuestions["選擇題"].push(c);
        }
      }

      shuffleArray(selectedQuestions["是非題"]);
      shuffleArray(selectedQuestions["選擇題"]);
      return true;
    }

    function selectQuestionsTraffic(){
      selectedQuestions = { "是非題": [], "選擇題": [] };

      let totalTF = parseInt(customTfInput.value, 10) || 20;  // 預設 25
      let totalMC = parseInt(customMcInput.value, 10) || 30; // 預設 25
      if(totalTF === 20 && totalMC === 30) {
        totalTF = 25;
        totalMC = 25;
      }

      // 檢查交通法令是否足
      if(totalTF > questions["交通法令"]["是非題"].length){
        alert(`你輸入出題題目大於題庫數量：交通法令 是非題僅有 ${questions["交通法令"]["是非題"].length} 題。`);
        return false;
      }
      if(totalMC > questions["交通法令"]["選擇題"].length){
        alert(`你輸入出題題目大於題庫數量：交通法令 選擇題僅有 ${questions["交通法令"]["選擇題"].length} 題。`);
        return false;
      }

      // 取得題目
      let tfAll = questions["交通法令"]["是非題"];
      let mcAll = questions["交通法令"]["選擇題"];
      selectedQuestions["是非題"] = randomPick(tfAll, totalTF);
      selectedQuestions["選擇題"] = randomPick(mcAll, totalMC);
      return true;
    }

    /*
     * 9. 分頁顯示測驗題目與回填
     * ---------------------------------------------------------- */
    function showQuestionPage(){
      const titleEl = document.getElementById('quiz-page-title');
      const navEl = document.getElementById('quiz-nav');
      const qArea = document.getElementById('quiz-questions');
      titleEl.textContent = "";
      navEl.innerHTML = "";
      qArea.innerHTML = "";

      // 分頁資料
      let combined;
      if(wrongMode){
        // 錯誤題目練習
        let geoTF = selectedQuestions["是非題"].filter(q => q.region !== "交通法令");
        let tfTraffic = selectedQuestions["是非題"].filter(q => q.region === "交通法令");
        let geoMC = selectedQuestions["選擇題"].filter(q => q.region !== "交通法令");
        let mcTraffic = selectedQuestions["選擇題"].filter(q => q.region === "交通法令");
        combined = [...geoTF, ...tfTraffic, ...geoMC, ...mcTraffic];
        let allCount = combined.length;
        totalPage = Math.ceil(allCount / 10);
        let startIndex = currentPage * 10;
        let endIndex = startIndex + 10;
        if(endIndex > allCount) endIndex = allCount;
        let pageData = combined.slice(startIndex, endIndex);
        titleEl.textContent = `錯誤題目練習：第 ${startIndex+1} ~ ${endIndex} 題 (共 ${allCount} 題)`;

        pageData.forEach((qObj, idx) => {
          let globalQNum = currentPage * 10 + idx + 1;
          createQuestionBlock(qArea, qObj, globalQNum);
        });
      }
      else {
        // 一般地理 or 交通
        let allData = [...selectedQuestions["是非題"], ...selectedQuestions["選擇題"]];
        let allCount = allData.length;
        totalPage = Math.ceil(allCount / 10);
        let startIndex = currentPage * 10;
        let endIndex = startIndex + 10;
        if(endIndex > allCount) endIndex = allCount;
        let pageData = allData.slice(startIndex, endIndex);

        if(!trafficMode){
          titleEl.textContent = `地理環境測驗：第 ${startIndex+1} ~ ${endIndex} 題 (共 ${allCount} 題)`;
        } else {
          titleEl.textContent = `交通法規測驗：第 ${startIndex+1} ~ ${endIndex} 題 (共 ${allCount} 題)`;
        }
        pageData.forEach((qObj, idx) => {
          let globalQNum = currentPage * 10 + idx + 1;
          createQuestionBlock(qArea, qObj, globalQNum);
        });
      }

      // 分頁按鈕
      if(currentPage > 0){
        const prevBtn = document.createElement('button');
        prevBtn.className = "btn";
        prevBtn.textContent = "上一頁";
        prevBtn.style.marginRight = "20px";
        prevBtn.onclick = goPrev;
        navEl.appendChild(prevBtn);
      }
      if(currentPage < totalPage - 1){
        const nextBtn = document.createElement('button');
        nextBtn.className = "btn";
        nextBtn.textContent = "下一頁";
        nextBtn.onclick = goNext;
        navEl.appendChild(nextBtn);
      } else {
        const calcBtn = document.createElement('button');
        calcBtn.className = "btn";
        calcBtn.textContent = "計算成績";
        calcBtn.onclick = calculateScore;
        navEl.appendChild(calcBtn);
      }
      window.scrollTo(0, 0);
    }

    function createQuestionBlock(container, qObj, globalQNum){
      const block = document.createElement('div');
      block.className = 'question-block';
      block.innerHTML = `<b>${globalQNum}. ${qObj.question}</b><br/>`;
      if(!qObj.options){
        block.innerHTML += `
          <label><input type="radio" name="q${globalQNum}" value="1"> 是</label><br/>
          <label><input type="radio" name="q${globalQNum}" value="2"> 否</label>
        `;
      } else {
        let sortedKeys = Object.keys(qObj.options).sort((a, b) => parseInt(a) - parseInt(b));
        sortedKeys.forEach(k => {
          block.innerHTML += `
            <label><input type="radio" name="q${globalQNum}" value="${k}"> (${k}) ${qObj.options[k]}</label><br/>
          `;
        });
      }
      container.appendChild(block);

      // 回填作答
      const savedVal = userAnswers[globalQNum];
      if(savedVal !== undefined){
        const radioToCheck = block.querySelector(`input[name="q${globalQNum}"][value="${savedVal}"]`);
        if(radioToCheck) radioToCheck.checked = true;
      }
    }

    function goPrev(){
      saveAnswers();
      if(currentPage > 0){
        currentPage--;
        showQuestionPage();
      }
    }

    function goNext(){
      saveAnswers();
      if(currentPage < totalPage - 1){
        currentPage++;
        showQuestionPage();
      } else {
        calculateScore();
      }
    }

    function saveAnswers(){
      const quizQArea = document.getElementById('quiz-questions');
      const checkedRadios = quizQArea.querySelectorAll('input[type="radio"]:checked');
      checkedRadios.forEach(radio => {
        let name = radio.name;
        let qNum = parseInt(name.replace('q',''),10);
        userAnswers[qNum] = parseInt(radio.value,10);
      });
    }

    /*
     * 10. 計算成績 & 顯示結果 (含更新錯題)
     * ---------------------------------------------------------- */
    function calculateScore(){
      saveAnswers();

      let allQuestions = [];
      if(wrongMode){
        // 將錯誤題庫依地理/交通排序過的合併
        let geoTF = selectedQuestions["是非題"].filter(q => q.region !== "交通法令");
        let tfTraffic = selectedQuestions["是非題"].filter(q => q.region === "交通法令");
        let geoMC = selectedQuestions["選擇題"].filter(q => q.region !== "交通法令");
        let mcTraffic = selectedQuestions["選擇題"].filter(q => q.region === "交通法令");
        allQuestions = [...geoTF, ...tfTraffic, ...geoMC, ...mcTraffic];
      } else {
        // 一般地理/交通
        allQuestions = [...selectedQuestions["是非題"], ...selectedQuestions["選擇題"]];
      }

      let totalQ = allQuestions.length;
      let correctCount = 0;
      let stillWrong = [];  // 下次仍然保留在錯誤題庫的題目
      let currentWrong = []; // 本次測驗中答錯的題目

      allQuestions.forEach((qObj, idx) => {
        let qNum = idx + 1; // 只做識別用
        let userAns = userAnswers[qNum] || 0;
        if(userAns === qObj.answer){
          // 答對
          correctCount++;
        } else {
          // 答錯
          let newWrong = Object.assign({}, qObj);
          currentWrong.push(newWrong);
        }
      });

      // 分數計算：每題 (100 / totalQ)
      let perScore = 100 / totalQ;
      let rawScore = correctCount * perScore;
      score = parseFloat(rawScore.toFixed(2)); // 保留2位小數

      // 若是錯題練習 => 要把「本次答對了」的題目 從 wrongQuestions 裡刪除
      // step: 先把 "stillWrong" 放=wrongQuestions, 再移除本次答對的
      if(wrongMode){
        // 取得本次題目的 ID
        // 其實我們可以用 question + answer 來判斷
        let questionSet = new Set();
        allQuestions.forEach(q => {
          let key = q.region + "|" + q.question + "|" + q.answer;
          questionSet.add(key);
        });

        // 先複製
        stillWrong = wrongQuestions.filter(w => {
          // 如果本次有出現(在questionSet裡)，且本次還是錯 => 保留
          let wKey = w.region + "|" + w.question + "|" + w.answer;
          // 本次測驗沒出現 or 這次答對了 => 不保留
          // 但是要判斷 "這次錯了嗎" => currentWrong 會有
          let isInThisQuiz = questionSet.has(wKey);
          let isStillWrong = currentWrong.some(x => {
            let cKey = x.region + "|" + x.question + "|" + x.answer;
            return cKey === wKey;
          });
          return !isInThisQuiz || isStillWrong;
        });

        wrongQuestions = stillWrong.slice(); // 更新全域 wrongQuestions
        localStorage.setItem("wrongQuestions", JSON.stringify(wrongQuestions));
      } else {
        // 若不是錯題練習 => 把 currentWrong 加入 wrongQuestions
        if(currentWrong.length > 0){
          let toAdd = [];
          currentWrong.forEach(wObj => {
            let key = wObj.region + "|" + wObj.question + "|" + wObj.answer;
            let exist = wrongQuestions.some(k => {
              let kKey = k.region + "|" + k.question + "|" + k.answer;
              return kKey === key;
            });
            if(!exist) toAdd.push(wObj);
          });
          if(toAdd.length > 0){
            wrongQuestions.push(...toAdd);
            localStorage.setItem("wrongQuestions", JSON.stringify(wrongQuestions));
          }
        }
      }

      QUIZ_CONTAINER.classList.add('hidden');
      RESULT_CONTAINER.classList.remove('hidden');
      showScore(currentWrong);
    }

    function showScore(currentWrong){
      const resDiv = document.getElementById('result-area');
      resDiv.innerHTML = "";

      let msg = (score >= 70)
        ? `您的成績：${score} 分 (及格)`
        : `您的成績：${score} 分 (不及格)`;
      let p = document.createElement('p');
      p.className = 'result';
      p.textContent = msg;
      resDiv.appendChild(p);

      // 訂正錯誤
      const corrBtn = document.createElement('button');
      corrBtn.className = "btn";
      corrBtn.textContent = "訂正錯誤";
      corrBtn.onclick = () => showCorrections(currentWrong);
      resDiv.appendChild(corrBtn);

      // 重新考試
      const retakeBtn = document.createElement('button');
      retakeBtn.className = "btn";
      retakeBtn.textContent = "重新考試";
      retakeBtn.style.marginLeft = "10px";
      retakeBtn.onclick = retakeQuiz;
      resDiv.appendChild(retakeBtn);

      // 回首頁
      const homeBtn = document.createElement('button');
      homeBtn.className = "btn";
      homeBtn.textContent = "顯示首頁";
      homeBtn.style.marginLeft = "10px";
      homeBtn.onclick = () => {
        RESULT_CONTAINER.classList.add('hidden');
        HOME_CONTAINER.classList.remove('hidden');
        window.scrollTo(0, 0);
      };
      resDiv.appendChild(homeBtn);

      window.scrollTo(0, 0);
    }

    function showCorrections(currentWrong){
      const resDiv = document.getElementById('result-area');
      resDiv.innerHTML = "<h3>訂正錯誤</h3>";

      if(!currentWrong || currentWrong.length === 0){
        resDiv.innerHTML += `<p>恭喜！沒有答錯任何一題</p>`;
      } else {
        const ul = document.createElement('ul');
        ul.style.listStyleType = "none";
        currentWrong.forEach((wObj, idx) => {
          let qNum = idx + 1;
          let ansDisplay = "";
          if(!wObj.options){
            let ansMap = {1:"是", 2:"否"};
            ansDisplay = `${wObj.answer}. ${ansMap[wObj.answer]}`;
          } else {
            if(wObj.options[wObj.answer]){
              ansDisplay = `${wObj.answer}. ${wObj.options[wObj.answer]}`;
            } else {
              ansDisplay = wObj.answer + ". [未知選項]";
            }
          }
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="wrong"><b>第${qNum}題</b> (${wObj.region}) ${wObj.question}</div>
            <div style="margin-left:20px;">
              正確答案：<span class="correct">${ansDisplay}</span>
            </div>
          `;
          ul.appendChild(li);
        });
        resDiv.appendChild(ul);
      }

      // 重新考試按鈕
      const retakeBtn = document.createElement('button');
      retakeBtn.className = "btn";
      retakeBtn.textContent = "重新考試";
      retakeBtn.onclick = retakeQuiz;
      resDiv.appendChild(retakeBtn);

      // 回首頁
      const homeBtn = document.createElement('button');
      homeBtn.className = "btn";
      homeBtn.textContent = "顯示首頁";
      homeBtn.style.marginLeft = "10px";
      homeBtn.onclick = () => {
        RESULT_CONTAINER.classList.add('hidden');
        HOME_CONTAINER.classList.remove('hidden');
        window.scrollTo(0, 0);
      };
      resDiv.appendChild(homeBtn);
    }

    function retakeQuiz(){
      if(confirm("是否要回到首頁？")){
        RESULT_CONTAINER.classList.add('hidden');
        HOME_CONTAINER.classList.remove('hidden');
        window.scrollTo(0, 0);
      } else {
        if(wrongMode){
          startWrongPractice();
        } else if(trafficMode){
          startTrafficTest();
        } else {
          startGeoTest();
        }
      }
    }

    /*
     * 11. 工具函式
     * ---------------------------------------------------------- */
    function randomPick(arr, count){
      let copy = arr.slice();
      shuffleArray(copy);
      return copy.slice(0, count);
    }
    function randomItem(arr){
      return arr[Math.floor(Math.random() * arr.length)];
    }
    function shuffleArray(array){
      for(let i = array.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }
  </script>
</body>
</html>
