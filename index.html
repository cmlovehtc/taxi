<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <!-- 手機RWD -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>地理環境 &amp; 交通法規測驗｜計程車考試｜台灣計程車模擬考｜執業登記證考試</title>
  <!-- 新增搜尋引擎關鍵字 -->
  <meta name="keywords" content="地理環境, 交通法規, 計程車考試, 台灣計程車模擬考, 執業登記證考試, 智能題庫隨行, 題庫檢視, 全國首創">
  <style>
    /* 基本版型 */
    body {
      font-family: sans-serif;
      background: #f8fafc;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background: #ffffff;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2, h3 {
      color: #333;
      margin-top: 0;
    }
    .btn {
      display: inline-block;
      padding: 8px 15px;
      margin: 5px 0;
      color: #fff;
      background-color: #1c4966;
      border-radius: 4px;
      text-decoration: none;
      cursor: pointer;
      border: none;
    }
    .btn:hover {
      background-color: #16667a;
    }
    .region-row {
      margin-bottom: 8px;
    }
    .question-block {
      border: 1px solid #ccc;
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .footer {
      margin-top: 20px;
      padding: 10px;
      text-align: center;
      background: #eef4f9;
    }
    .result {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 10px 0;
    }
    .wrong {
      color: red;
    }
    .correct {
      color: green;
    }
    .hidden {
      display: none;
    }
    .stats-table {
      border-collapse: collapse;
      margin: 10px 0;
    }
    .stats-table th,
    .stats-table td {
      border: 1px solid #ccc;
      padding: 6px 8px;
    }
    .stats-table th {
      background: #f0f0f0;
    }
    .scroll-box {
      border: 1px solid #ccc;
      padding: 10px;
      max-height: 400px;
      overflow-y: auto;
      margin: 10px 0;
      border-radius: 4px;
    }
    /* 載入指示器 */
    #loading-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    /* 縣市選項，每行三個 */
    #region-checkboxes {
      display: flex;
      flex-wrap: wrap;
    }
    #region-checkboxes label {
      width: 33.33%;
      box-sizing: border-box;
      padding: 5px 0;
    }
    @media (max-width: 600px) {
      .container {
        margin: 0 10px;
        box-shadow: none;
      }
      .question-block {
        font-size: 16px;
      }
      .btn {
        font-size: 14px;
      }
      #region-checkboxes label {
        width: 50%;
      }
    }
    /* 題庫檢視區樣式 */
    .bank-page-container {
      display: flex;
      flex-direction: column;
    }
    .bank-top-nav {
      margin-bottom: 10px;
      text-align: center;
    }
    .bank-top-nav button {
      margin: 0 5px;
    }
    /* 修改這裡，設定兩欄比例，左邊寬、右邊窄 */
    .bank-content-page {
      display: grid;
      grid-template-columns: calc(100% - 80px) 80px;
      gap: 10px;
      padding: 10px;
      border-top: 1px solid #ccc;
    }
    .bank-question {
      padding: 5px;
      /* 如果需要，可再針對左側額外設定 */
    }
    .bank-answer {
      padding: 5px;
      /* 預設隱藏答案 */
      color: transparent;
      transition: color 0.3s;
      text-align: right; /* 靠右顯示 */
    }
    .bank-answer.show,
    .bank-answer:hover {
      color: #333;
    }
    .bank-pagination {
      margin-top: 10px;
      text-align: center;
    }
    /* 固定下方的說明列 */
    .bank-footer {
      position: sticky;
      bottom: 0;
      background: #eef4f9;
      padding: 5px;
      text-align: center;
      font-weight: bold;
      border-top: 1px solid #ccc;
    }
    /* ------------------------------
       新增：提示目前選取題目或答案的樣式
       ------------------------------ */
    .highlight {
      background-color: #fffae6;
    }
    .bank-question:hover,
    .bank-answer:hover {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 載入指示器 -->
    <div id="loading-indicator" class="hidden">
      <p>正在載入題庫，請稍候...</p>
    </div>

    <!-- 首頁容器 (Home) -->
    <div id="home-container">
      <h1>全國版 地理環境 &amp; 交通法規測驗</h1>
      <h2>計程車考試｜台灣計程車模擬考｜執業登記證考試</h2>
      <p>全國首創 <strong>智能題庫隨行</strong> 機制，讓您在檢視題庫時，移動或點擊題目即可即時顯示正確答案，提供最佳考前複習體驗！</p>
      <h3>請輸入各縣市的比例 (總和=100)</h3>
      <div id="region-inputs"></div>
      <div style="margin-top:10px;">
        <button class="btn" id="start-geo">地理位置開始測驗</button>
        <button class="btn" id="start-traffic">開始交通法規測驗（50題）</button>
        <button class="btn" id="view-bank-menu">查看題庫</button>
      </div>
      <h3>選擇要包含的縣市</h3>
      <div id="region-checkboxes"></div>
      <button class="btn" id="calculate-stats">計算統計</button>
      <h3>各縣市題庫數量及統計</h3>
      <div id="stats-info" class="hidden"></div>
      <div class="footer">
        郭建隆自動出題程式祝大家考試順利<br>
        更新日期:2025/1/10日<br>
        郭建隆版權所有<br>
        聯絡作者: cmlovehtc@gmail.com<br>
        LINE: cmlovehtc(歡迎加LINE提供你考試密技，計程車車隊分析)
      </div>
    </div>

    <!-- 題庫選單 & 內容容器 (Bank) -->
    <div id="bank-container" class="hidden">
      <h2>查看題庫選單</h2>
      <!-- 修改後的說明文字 -->
      <div id="bank-menu"></div>
      <hr>
      <div id="bank-content"></div>
    </div>

    <!-- 測驗容器 (Quiz) -->
    <div id="quiz-container" class="hidden">
      <h3 id="quiz-page-title"></h3>
      <div id="quiz-questions"></div>
      <div id="quiz-nav" style="margin:10px 0;"></div>
    </div>

    <!-- 結果容器 (Result) -->
    <div id="result-container" class="hidden">
      <div id="result-area"></div>
    </div>
  </div>

  <script>
    // 1. 全域變數、初始設定
    const REGIONS = [
      "基隆市","宜蘭縣","新北市","桃園市","新竹市",
      "新竹縣","苗栗縣","臺北市","臺中市","南投縣",
      "彰化縣","雲林縣","嘉義縣","嘉義市","臺南市",
      "高雄市","屏東縣","花蓮縣","臺東縣","澎湖縣",
      "金門縣","連江縣"
    ];
    const QUESTION_TYPES = ["是非題","選擇題"];

    const HOME_CONTAINER   = document.getElementById('home-container');
    const QUIZ_CONTAINER   = document.getElementById('quiz-container');
    const RESULT_CONTAINER = document.getElementById('result-container');
    const BANK_CONTAINER   = document.getElementById('bank-container');
    const LOADING_INDICATOR = document.getElementById('loading-indicator');

    // questions[region] = { "是非題": [...], "選擇題": [...] }
    let questions = {};
    REGIONS.forEach(r => {
      questions[r] = { "是非題": [], "選擇題": [] };
    });
    questions["交通法令"] = { "是非題": [], "選擇題": [] };

    let proportions = {};
    let selectedQuestions = { "是非題": [], "選擇題": [] };
    let userAnswers = {};   // key: 全卷題號, val: 使用者選的選項數字
    let correctAnswers = {}; // key: 全卷題號, val: 正確選項
    let score = 0;
    let trafficMode = false;
    let currentPage = 0; // 用於一般測驗分頁

    // 以下變數用於題庫檢視分頁
    let bankCurrentPage = 0;
    let bankAllData = [];  // 儲存目前顯示的題庫資料（物件包含 { index, question, answer, options }）
    let bankTotalPages = 0;
    let bankShowAllAnswer = false; // 預設隱藏答案

    // 2. 建立「輸入比例」區 & 綁定按鈕
    const regionInputsDiv = document.getElementById('region-inputs');
    REGIONS.forEach(r => {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'region-row';
      rowDiv.innerHTML = `
        <label>${r}</label>
        <input type="number" id="prop-${r}" value="0" style="width:60px; margin-left:10px;">
      `;
      regionInputsDiv.appendChild(rowDiv);
    });

    document.getElementById('start-traffic').addEventListener('click', startTrafficTest);
    document.getElementById('start-geo').addEventListener('click', startGeoTest);
    document.getElementById('view-bank-menu').addEventListener('click', showBankMenu);
    document.getElementById('calculate-stats').addEventListener('click', renderStatsInfo);

    window.addEventListener('DOMContentLoaded', async () => {
      await loadAllQuestions();
      renderRegionCheckboxes();
      renderBankMenu();
    });

    // 3. 載入題庫 (平行載入所有 TXT 檔案)
    async function loadAllQuestions() {
      LOADING_INDICATOR.classList.remove('hidden');
      const fetchPromises = [];
      for (const region of [...REGIONS, "交通法令"]) {
        for (const qtype of QUESTION_TYPES) {
          let filename = (region === "交通法令")
            ? `${region}_${qtype}.txt`
            : `${region}_地理環境_${qtype}.txt`;
          const fetchPromise = fetch(filename)
            .then(res => {
              if (!res.ok) {
                console.log(`無法讀取: ${filename}`);
                return null;
              }
              return res.text();
            })
            .then(text => {
              if (text) {
                parseTextToQuestions(region, qtype, text);
              }
            })
            .catch(e => {
              console.log(`fetch 錯誤: ${filename}`, e);
            });
          fetchPromises.push(fetchPromise);
        }
      }
      await Promise.all(fetchPromises);
      LOADING_INDICATOR.classList.add('hidden');
    }

    function parseTextToQuestions(region, qtype, text) {
      const lines = text.split('\n');
      const patternParen = /\((\d+)\)([^()]*)/g;
      lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        if (line.includes("答案:")) {
          const [qpart, apart] = line.split("答案:");
          const questionText = qpart.trim();
          const answerText = apart.trim();
          if(qtype === "是非題") {
            let ansVal = 0;
            if(answerText === "是") ansVal = 1;
            else if(answerText === "否") ansVal = 2;
            if(ansVal > 0) {
              questions[region][qtype].push({
                question: questionText,
                answer: ansVal  // 1=是, 2=否
              });
            }
          } else {
            // 選擇題
            let matches = [...questionText.matchAll(patternParen)];
            if(matches.length > 0) {
              const firstIndex = questionText.indexOf(`(${matches[0][1]})`);
              const qTxt = questionText.slice(0, firstIndex).trim();
              let opts = {};
              matches.forEach(m => {
                let num = parseInt(m[1], 10);
                let txt = m[2].replace(/[。]/g, "").trim();
                opts[num] = txt;
              });
              let correct = parseInt(answerText, 10) || 0;
              questions[region][qtype].push({
                question: qTxt,
                options: opts,
                answer: correct
              });
            } else {
              questions[region][qtype].push({
                question: questionText,
                options: {},
                answer: answerText
              });
            }
          }
        }
      });
    }

    // 4. 建立勾選框
    function renderRegionCheckboxes() {
      const checkboxDiv = document.getElementById('region-checkboxes');
      checkboxDiv.innerHTML = "";
      REGIONS.forEach(r => {
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" value="${r}"> ${r}`;
        checkboxDiv.appendChild(label);
      });
    }

    // 5. 統計資訊
    function renderStatsInfo() {
      const statsDiv = document.getElementById('stats-info');
      statsDiv.innerHTML = "";
      const selectedRegions = Array.from(document.querySelectorAll('#region-checkboxes input[type="checkbox"]:checked'))
                                .map(cb => cb.value);
      if(selectedRegions.length === 0){
        alert("請至少選擇一個縣市來顯示統計資訊。");
        return;
      }
      const table = document.createElement('table');
      table.className = 'stats-table';
      table.innerHTML = `
        <thead>
          <tr>
            <th>地區(或交通法令)</th>
            <th>是非題數量(是/否)</th>
            <th>選擇題數量(1/2/3)</th>
          </tr>
        </thead>
      `;
      let tbody = document.createElement('tbody');
      [...selectedRegions, "交通法令"].forEach(region => {
        let tfArr = questions[region]["是非題"];
        let mcArr = questions[region]["選擇題"];
        let tfTrue = tfArr.filter(q => q.answer === 1).length;
        let tfFalse = tfArr.filter(q => q.answer === 2).length;
        let tfDesc = `${tfArr.length} 題(是:${tfTrue}, 否:${tfFalse})`;
        if(tfTrue > tfFalse){
          tfDesc += `，出現較多：是(${tfTrue})`;
        } else if(tfFalse > tfTrue){
          tfDesc += `，出現較多：否(${tfFalse})`;
        }
        let mcCount1 = mcArr.filter(q => q.answer === 1).length;
        let mcCount2 = mcArr.filter(q => q.answer === 2).length;
        let mcCount3 = mcArr.filter(q => q.answer === 3).length;
        let mcDesc = `${mcArr.length} 題(1:${mcCount1}, 2:${mcCount2}, 3:${mcCount3})`;
        let maxVal = Math.max(mcCount1, mcCount2, mcCount3);
        if(maxVal > 0){
          let tmp = [];
          if(mcCount1 === maxVal) tmp.push("1");
          if(mcCount2 === maxVal) tmp.push("2");
          if(mcCount3 === maxVal) tmp.push("3");
          mcDesc += `，出現最多：${tmp.join("/")} (${maxVal})`;
        }
        let tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${region}</td>
          <td>${tfDesc}</td>
          <td>${mcDesc}</td>
        `;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      statsDiv.appendChild(table);
      statsDiv.classList.remove('hidden');
      statsDiv.scrollIntoView({ behavior: 'smooth' });
    }

    // 6. 題庫檢視功能
    // 點選「查看題庫」後切換到題庫區
    function showBankMenu(){
      HOME_CONTAINER.classList.add('hidden');
      QUIZ_CONTAINER.classList.add('hidden');
      RESULT_CONTAINER.classList.add('hidden');
      BANK_CONTAINER.classList.remove('hidden');
      renderBankMenu();
      document.getElementById('bank-content').innerHTML = "";
    }

    // 題庫選單：僅在題庫選單畫面顯示各縣市及題型按鈕
    function renderBankMenu(){
      const bankMenuDiv = document.getElementById('bank-menu');
      bankMenuDiv.innerHTML = "";
      let listAll = [...REGIONS, "交通法令"];
      listAll.forEach(region => {
        QUESTION_TYPES.forEach(qtype => {
          let btn = document.createElement('button');
          btn.className = "btn";
          btn.style.marginRight = "6px";
          btn.textContent = `${region} ${qtype}`;
          btn.onclick = () => {
            bankCurrentPage = 0;
            bankShowAllAnswer = false;
            // 點選後隱藏題庫選單按鈕區
            bankMenuDiv.innerHTML = "";
            showQuestionBank(region, qtype);
          };
          bankMenuDiv.appendChild(btn);
        });
        bankMenuDiv.appendChild(document.createElement('br'));
      });
    }

    // 新增：針對滑鼠與行動裝置事件，統一加入提示效果
    function addHighlightEvents(leftDiv, rightDiv) {
      // 桌機：滑鼠事件
      leftDiv.addEventListener('mouseenter', () => {
        rightDiv.classList.add('show');
        leftDiv.classList.add('highlight');
        rightDiv.classList.add('highlight');
      });
      leftDiv.addEventListener('mouseleave', () => {
        if(!bankShowAllAnswer) {
          rightDiv.classList.remove('show');
        }
        leftDiv.classList.remove('highlight');
        rightDiv.classList.remove('highlight');
      });
      leftDiv.addEventListener('click', () => {
        rightDiv.classList.toggle('show');
        leftDiv.classList.toggle('highlight');
        rightDiv.classList.toggle('highlight');
      });
      // 行動裝置：touch事件改為直接點選效果（不在touchend時移除）
      leftDiv.addEventListener('touchstart', (e) => {
        // 取消預設行為避免重複觸發
        e.preventDefault();
        rightDiv.classList.toggle('show');
        leftDiv.classList.toggle('highlight');
        rightDiv.classList.toggle('highlight');
      });
      
      // 同理：右側答案區事件也調整為直接點選效果
      rightDiv.addEventListener('mouseenter', () => {
        leftDiv.classList.add('highlight');
        rightDiv.classList.add('highlight');
      });
      rightDiv.addEventListener('mouseleave', () => {
        leftDiv.classList.remove('highlight');
        rightDiv.classList.remove('highlight');
      });
      rightDiv.addEventListener('touchstart', (e) => {
        e.preventDefault();
        leftDiv.classList.toggle('highlight');
        rightDiv.classList.toggle('highlight');
      });
    }

    // 修改後的 showQuestionBank：
    // 進入題庫檢視模式後，
    // 畫面僅顯示題庫內容，最上方固定控制鈕：
    // 「回題庫選單」、「回首頁」、「顯示所有答案」
    // 每頁 50 題，以 grid 方式左右分欄呈現，
    // 左側欄：若是選擇題則顯示題目與所有選項；是非題則僅顯示題目。
    // 右側欄：僅顯示正確答案；（移動或點擊左側欄時自動顯示對應答案）
    // 下方固定顯示說明：移動或點擊題目會顯示答案。
    function showQuestionBank(region, qtype){
      const bankContent = document.getElementById('bank-content');
      bankContent.innerHTML = `
        <div class="bank-top-nav">
          <button class="btn" id="back-to-menu">回題庫選單</button>
          <button class="btn" id="back-to-home">回首頁</button>
          <button class="btn" id="toggle-answer">顯示所有答案</button>
        </div>
        <div id="bank-page-view" class="bank-page-container"></div>
        <div class="bank-footer">移動或點擊題目會顯示答案</div>
      `;
      document.getElementById('back-to-menu').addEventListener('click', () => {
        renderBankMenu();
        bankContent.innerHTML = "";
        window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
      });
      document.getElementById('back-to-home').addEventListener('click', () => {
        BANK_CONTAINER.classList.add('hidden');
        HOME_CONTAINER.classList.remove('hidden');
        bankContent.innerHTML = "";
        window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
      });
      document.getElementById('toggle-answer').addEventListener('click', () => {
        bankShowAllAnswer = !bankShowAllAnswer;
        const toggleBtn = document.getElementById('toggle-answer');
        toggleBtn.textContent = bankShowAllAnswer ? "隱藏所有答案" : "顯示所有答案";
        renderBankPage(qtype);
      });
      // 準備資料：取出該縣市、該題型題庫資料（依原順序）
      let arr = questions[region][qtype];
      bankAllData = [];
      arr.forEach((qObj, idx) => {
        bankAllData.push(Object.assign({ index: idx + 1 }, qObj));
      });
      bankTotalPages = Math.ceil(bankAllData.length / 50);
      bankCurrentPage = 0;
      renderBankPage(qtype);
    }

    // 題庫分頁函式，參數 qtype 用以決定左右欄呈現內容
    function renderBankPage(qtype){
      const pageView = document.getElementById('bank-page-view');
      if(!pageView) return;
      pageView.innerHTML = "";
      // 分頁資訊及上下頁按鈕
      const paginationDiv = document.createElement('div');
      paginationDiv.className = "bank-pagination";
      paginationDiv.innerHTML = `第 ${bankCurrentPage + 1} 頁，共 ${bankTotalPages} 頁`;
      pageView.appendChild(paginationDiv);
      const navDiv = document.createElement('div');
      navDiv.className = "bank-pagination";
      if(bankCurrentPage > 0){
        const prevBtn = document.createElement('button');
        prevBtn.className = "btn";
        prevBtn.textContent = "上一頁";
        prevBtn.onclick = () => {
          bankCurrentPage--;
          renderBankPage(qtype);
        };
        navDiv.appendChild(prevBtn);
      }
      if(bankCurrentPage < bankTotalPages - 1){
        const nextBtn = document.createElement('button');
        nextBtn.className = "btn";
        nextBtn.textContent = "下一頁";
        nextBtn.onclick = () => {
          bankCurrentPage++;
          renderBankPage(qtype);
        };
        navDiv.appendChild(nextBtn);
      }
      pageView.appendChild(navDiv);
      // 本頁資料：每頁 50 題
      const start = bankCurrentPage * 50;
      const end = start + 50;
      const pageData = bankAllData.slice(start, end);
      // 使用 grid 以左右分欄呈現
      const contentDiv = document.createElement('div');
      contentDiv.className = "bank-content-page";
      pageData.forEach(item => {
        // 左側欄：若是選擇題則顯示題目與所有選項；是非題則僅顯示題目。
        const leftDiv = document.createElement('div');
        leftDiv.className = "bank-question";
        let leftContent = `<b>${item.index}. </b>${item.question}`;
        if(qtype === "選擇題"){
          if(item.options && Object.keys(item.options).length > 0){
            leftContent += "<br/>";
            const sortedKeys = Object.keys(item.options).sort((a, b) => parseInt(a) - parseInt(b));
            sortedKeys.forEach(k => {
              leftContent += `(${k}) ${item.options[k]}<br/>`;
            });
          }
        }
        leftDiv.innerHTML = leftContent;
        
        // 右側欄：僅顯示正確答案；是非題顯示「是/否」，選擇題顯示正確答案數字
        const rightDiv = document.createElement('div');
        rightDiv.className = "bank-answer";
        if(qtype === "選擇題"){
          rightDiv.innerHTML = `<b>${item.answer}</b>`;
        } else {
          let ansText = (item.answer === 1) ? "是" : "否";
          rightDiv.innerHTML = `<b>${ansText}</b>`;
        }
        if(bankShowAllAnswer){
          rightDiv.classList.add('show');
        } else {
          rightDiv.classList.remove('show');
        }
        // 使用 addHighlightEvents 函式，統一針對滑鼠與觸控事件加入提示效果
        addHighlightEvents(leftDiv, rightDiv);
        
        contentDiv.appendChild(leftDiv);
        contentDiv.appendChild(rightDiv);
      });
      pageView.appendChild(contentDiv);
      pageView.scrollIntoView({ behavior: 'smooth' });
    }

    // 7. 開始測驗 (交通/地理)
    function startTrafficTest(){
      trafficMode = true;
      selectQuestionsTraffic();
      currentPage = 0;
      userAnswers = {};
      correctAnswers = {};
      HOME_CONTAINER.classList.add('hidden');
      BANK_CONTAINER.classList.add('hidden');
      RESULT_CONTAINER.classList.add('hidden');
      QUIZ_CONTAINER.classList.remove('hidden');
      showQuestionPage();
    }
    function startGeoTest(){
      trafficMode = false;
      let total = 0;
      proportions = {};
      REGIONS.forEach(r => {
        let val = document.getElementById(`prop-${r}`).value;
        let num = parseInt(val,10) || 0;
        proportions[r] = num;
        total += num;
      });
      if(total !== 100){
        alert(`縣市比例加總必須為100，目前為 ${total}`);
        return;
      }
      selectQuestionsCity();
      currentPage = 0;
      userAnswers = {};
      correctAnswers = {};
      HOME_CONTAINER.classList.add('hidden');
      BANK_CONTAINER.classList.add('hidden');
      RESULT_CONTAINER.classList.add('hidden');
      QUIZ_CONTAINER.classList.remove('hidden');
      showQuestionPage();
    }
    function selectQuestionsCity(){
      selectedQuestions = { "是非題": [], "選擇題": [] };
      score = 0;
      let totalTF = 20, totalMC = 30;
      REGIONS.forEach(r => {
        let need = Math.round(proportions[r] / 100 * totalTF);
        let pool = questions[r]["是非題"];
        if(pool.length > 0){
          let pickCount = Math.min(need, pool.length);
          let picked = randomPick(pool, pickCount);
          selectedQuestions["是非題"].push(...picked);
        }
      });
      while(selectedQuestions["是非題"].length < 20){
        let rr = randomItem(REGIONS);
        let p = questions[rr]["是非題"];
        if(!p.length) continue;
        let c = randomItem(p);
        if(!selectedQuestions["是非題"].includes(c)){
          selectedQuestions["是非題"].push(c);
        }
      }
      REGIONS.forEach(r => {
        let need = Math.round(proportions[r] / 100 * totalMC);
        let pool = questions[r]["選擇題"];
        if(pool.length > 0){
          let pickCount = Math.min(need, pool.length);
          let picked = randomPick(pool, pickCount);
          selectedQuestions["選擇題"].push(...picked);
        }
      });
      while(selectedQuestions["選擇題"].length < 30){
        let rr = randomItem(REGIONS);
        let p = questions[rr]["選擇題"];
        if(!p.length) continue;
        let c = randomItem(p);
        if(!selectedQuestions["選擇題"].includes(c)){
          selectedQuestions["選擇題"].push(c);
        }
      }
      shuffleArray(selectedQuestions["是非題"]);
      shuffleArray(selectedQuestions["選擇題"]);
    }
    function selectQuestionsTraffic(){
      selectedQuestions = { "是非題": [], "選擇題": [] };
      score = 0;
      let tfAll = questions["交通法令"]["是非題"];
      let mcAll = questions["交通法令"]["選擇題"];
      if(tfAll.length < 25){
        selectedQuestions["是非題"] = tfAll.slice();
      } else {
        selectedQuestions["是非題"] = randomPick(tfAll, 25);
      }
      if(mcAll.length < 25){
        selectedQuestions["選擇題"] = mcAll.slice();
      } else {
        selectedQuestions["選擇題"] = randomPick(mcAll, 25);
      }
      shuffleArray(selectedQuestions["是非題"]);
      shuffleArray(selectedQuestions["選擇題"]);
    }

    // 8. 分頁顯示測驗題目與回填
    function showQuestionPage(){
      const titleEl = document.getElementById('quiz-page-title');
      const navEl = document.getElementById('quiz-nav');
      const qArea = document.getElementById('quiz-questions');
      titleEl.textContent = "";
      navEl.innerHTML = "";
      qArea.innerHTML = "";
      let pageTitle = "";
      let questionsList = [];
      if(!trafficMode){
        if(currentPage < 2){
          let start = currentPage * 10, end = start + 10;
          questionsList = selectedQuestions["是非題"].slice(start, end);
          pageTitle = `是非題 第 ${start+1} ~ ${end} 題`;
        } else {
          let start = (currentPage - 2) * 10, end = start + 10;
          questionsList = selectedQuestions["選擇題"].slice(start, end);
          pageTitle = `選擇題 第 ${start+1} ~ ${end} 題`;
        }
      } else {
        if(currentPage < 2){
          let start = currentPage * 10, end = start + 10;
          questionsList = selectedQuestions["是非題"].slice(start, end);
          pageTitle = `交通法規 是非題 第 ${start+1} ~ ${end} 題`;
        } else if(currentPage === 2){
          let tfPart = selectedQuestions["是非題"].slice(20, 25);
          let mcPart = selectedQuestions["選擇題"].slice(0, 5);
          questionsList = tfPart.concat(mcPart);
          pageTitle = "交通法規 第 21 ~ 30 題（5 是非 + 5 選擇）";
        } else {
          if(currentPage === 3){
            questionsList = selectedQuestions["選擇題"].slice(5, 15);
            pageTitle = "交通法規 選擇題 第 31 ~ 40 題";
          } else {
            questionsList = selectedQuestions["選擇題"].slice(15, 25);
            pageTitle = "交通法規 選擇題 第 41 ~ 50 題";
          }
        }
      }
      titleEl.textContent = pageTitle;
      // 生成題目與回填
      questionsList.forEach((qObj, idx) => {
        const globalQNum = getGlobalQuestionNumber(idx);
        const block = document.createElement('div');
        block.className = 'question-block';
        block.innerHTML = `<b>${globalQNum}. ${qObj.question}</b><br/>`;
        if(!('options' in qObj)){
          block.innerHTML += `
            <label><input type="radio" name="q${globalQNum}" value="1"> 是</label><br/>
            <label><input type="radio" name="q${globalQNum}" value="2"> 否</label>
          `;
        } else {
          let sortedKeys = Object.keys(qObj.options).sort((a, b) => parseInt(a) - parseInt(b));
          sortedKeys.forEach(k => {
            block.innerHTML += `
              <label><input type="radio" name="q${globalQNum}" value="${k}"> (${k}) ${qObj.options[k]}</label><br/>
            `;
          });
        }
        qArea.appendChild(block);
        const savedVal = userAnswers[globalQNum];
        if(savedVal !== undefined){
          const radioToCheck = block.querySelector(`input[name="q${globalQNum}"][value="${savedVal}"]`);
          if(radioToCheck) radioToCheck.checked = true;
        }
      });
      if(currentPage > 0){
        const prevBtn = document.createElement('button');
        prevBtn.className = "btn";
        prevBtn.textContent = "上一頁";
        prevBtn.style.marginRight = "20px";
        prevBtn.onclick = goPrev;
        navEl.appendChild(prevBtn);
      }
      if(currentPage < 4){
        const nextBtn = document.createElement('button');
        nextBtn.className = "btn";
        nextBtn.textContent = "下一頁";
        nextBtn.onclick = goNext;
        navEl.appendChild(nextBtn);
      } else {
        const calcBtn = document.createElement('button');
        calcBtn.className = "btn";
        calcBtn.textContent = "計算成績";
        calcBtn.onclick = calculateScore;
        navEl.appendChild(calcBtn);
      }
      window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
    }
    function getGlobalQuestionNumber(localIndex){
      if(!trafficMode){
        if(currentPage < 2){
          return currentPage * 10 + localIndex + 1;
        } else {
          return 20 + (currentPage - 2) * 10 + localIndex + 1;
        }
      } else {
        if(currentPage < 2){
          return currentPage * 10 + localIndex + 1;
        } else if(currentPage === 2){
          return 20 + localIndex + 1;
        } else if(currentPage === 3){
          return 30 + localIndex + 1;
        } else {
          return 40 + localIndex + 1;
        }
      }
    }
    function goPrev(){
      saveAnswers();
      if(currentPage > 0){
        currentPage--;
        showQuestionPage();
      }
    }
    function goNext(){
      saveAnswers();
      if(currentPage < 4){
        currentPage++;
        showQuestionPage();
      } else {
        calculateScore();
      }
    }
    function saveAnswers(){
      const quizQArea = document.getElementById('quiz-questions');
      const checkedRadios = quizQArea.querySelectorAll('input[type="radio"]:checked');
      checkedRadios.forEach(radio => {
        let name = radio.name;
        let qNum = parseInt(name.replace('q',''),10);
        userAnswers[qNum] = parseInt(radio.value,10);
      });
    }
    function calculateScore(){
      saveAnswers();
      score = 0;
      correctAnswers = {};
      if(!trafficMode){
        selectedQuestions["是非題"].forEach((qObj, i) => {
          let qNum = i + 1;
          correctAnswers[qNum] = qObj.answer;
          if(userAnswers[qNum] === qObj.answer){
            score += 2;
          }
        });
        selectedQuestions["選擇題"].forEach((qObj, i) => {
          let qNum = 21 + i;
          correctAnswers[qNum] = qObj.answer;
          if(userAnswers[qNum] === qObj.answer){
            score += 2;
          }
        });
      } else {
        selectedQuestions["是非題"].forEach((qObj, i) => {
          let qNum = i + 1;
          correctAnswers[qNum] = qObj.answer;
          if(userAnswers[qNum] === qObj.answer){
            score += 2;
          }
        });
        selectedQuestions["選擇題"].forEach((qObj, i) => {
          let qNum = 26 + i;
          correctAnswers[qNum] = qObj.answer;
          if(userAnswers[qNum] === qObj.answer){
            score += 2;
          }
        });
      }
      QUIZ_CONTAINER.classList.add('hidden');
      RESULT_CONTAINER.classList.remove('hidden');
      showScore();
    }
    function showScore(){
      const resDiv = document.getElementById('result-area');
      resDiv.innerHTML = "";
      let msg = (score >= 70)
        ? `您的成績：${score} 分 (及格)`
        : `您的成績：${score} 分 (不及格)`;
      let p = document.createElement('p');
      p.className = 'result';
      p.textContent = msg;
      resDiv.appendChild(p);
      const corrBtn = document.createElement('button');
      corrBtn.className = "btn";
      corrBtn.textContent = "訂正錯誤";
      corrBtn.onclick = showCorrections;
      resDiv.appendChild(corrBtn);
      const retakeBtn = document.createElement('button');
      retakeBtn.className = "btn";
      retakeBtn.textContent = "重新考試";
      retakeBtn.style.marginLeft = "10px";
      retakeBtn.onclick = retakeQuiz;
      resDiv.appendChild(retakeBtn);
      const homeBtn = document.createElement('button');
      homeBtn.className = "btn";
      homeBtn.textContent = "顯示首頁";
      homeBtn.style.marginLeft = "10px";
      homeBtn.onclick = () => {
        RESULT_CONTAINER.classList.add('hidden');
        HOME_CONTAINER.classList.remove('hidden');
        window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
      };
      resDiv.appendChild(homeBtn);
      window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
    }
    function showCorrections(){
      const resDiv = document.getElementById('result-area');
      resDiv.innerHTML = "<h3>訂正錯誤</h3>";
      let wrongCount = 0;
      const ul = document.createElement('ul');
      ul.style.listStyleType = "none";
      for(let qNum in correctAnswers){
        qNum = parseInt(qNum, 10);
        let userAns = userAnswers[qNum] || 0;
        let corrAns = correctAnswers[qNum];
        if(userAns !== corrAns){
          wrongCount++;
          let theQuestionObj = null;
          if(!trafficMode){
            if(qNum <= 20){
              theQuestionObj = selectedQuestions["是非題"][qNum - 1];
            } else {
              theQuestionObj = selectedQuestions["選擇題"][qNum - 21];
            }
          } else {
            if(qNum <= 25){
              theQuestionObj = selectedQuestions["是非題"][qNum - 1];
            } else {
              theQuestionObj = selectedQuestions["選擇題"][qNum - 26];
            }
          }
          let userDisplay = "未作答";
          let corrDisplay = "未知";
          if(!("options" in theQuestionObj)){
            let ansMap = {1:"是", 2:"否"};
            userDisplay  = (userAns > 0) ? `${userAns}. ${ansMap[userAns]}` : "未作答";
            corrDisplay = `${corrAns}. ${ansMap[corrAns]}`;
          } else {
            const opts = theQuestionObj.options;
            if(userAns > 0 && opts[userAns]){
              userDisplay = `${userAns}. ${opts[userAns]}`;
            } else if(userAns === 0){
              userDisplay = "未作答";
            } else {
              userDisplay = userAns + ". [未定義選項]";
            }
            if(corrAns > 0 && opts[corrAns]){
              corrDisplay = `${corrAns}. ${opts[corrAns]}`;
            } else {
              corrDisplay = corrAns + ". [未知選項]";
            }
          }
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="wrong"><b>第${qNum}題</b> ${theQuestionObj.question}</div>
            <div style="margin-left:20px;">
              您的回答：<span class="wrong">${userDisplay}</span><br/>
              正確答案：<span class="correct">${corrDisplay}</span>
            </div>
          `;
          ul.appendChild(li);
        }
      }
      if(wrongCount === 0){
        resDiv.innerHTML += `<p>恭喜！沒有答錯任何一題</p>`;
      } else {
        resDiv.appendChild(ul);
      }
      const retakeBtn = document.createElement('button');
      retakeBtn.className = "btn";
      retakeBtn.textContent = "重新考試";
      retakeBtn.onclick = retakeQuiz;
      resDiv.appendChild(retakeBtn);
      const homeBtn = document.createElement('button');
      homeBtn.className = "btn";
      homeBtn.textContent = "顯示首頁";
      homeBtn.style.marginLeft = "10px";
      homeBtn.onclick = () => {
        RESULT_CONTAINER.classList.add('hidden');
        HOME_CONTAINER.classList.remove('hidden');
        window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
      };
      resDiv.appendChild(homeBtn);
    }
    function retakeQuiz(){
      if(confirm("是否要回到首頁？")){
        RESULT_CONTAINER.classList.add('hidden');
        HOME_CONTAINER.classList.remove('hidden');
        window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
      } else {
        if(trafficMode) startTrafficTest();
        else startGeoTest();
      }
    }
    // 10. 工具函式
    function randomPick(arr, count){
      let copy = arr.slice();
      shuffleArray(copy);
      return copy.slice(0, count);
    }
    function randomItem(arr){
      return arr[Math.floor(Math.random() * arr.length)];
    }
    function shuffleArray(array){
      for(let i = array.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }
  </script>
</body>
</html>
